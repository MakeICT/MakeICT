<!DOCTYPE html>

<html ng-app="electronic-door">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>

		<title>MakeICT Master Control Program</title>
		
		<link rel="icon" href="" />
		<link rel="stylesheet" href="/css/bootstrap/bootstrap.min.css" />
		<link rel="stylesheet" href="/css/bootstrap-slate.min.css" />
		<link rel="stylesheet" href="/css/mcp.css" />
		
		<script src="/js/jquery.min.js"></script>
		<script src="/js/socket.io.js"></script>
		<script src="/js/angular/angular.js"></script>
		<script src="/js/bootstrap/bootstrap.min.js"></script>
		<script src="/js/ui-bootstrap-tpls.min.js"></script>		
		<!-- current version of ui-bootstrap js file breaks accordian smooth transitions. old version fixes it -->
		<script src="//angular-ui.github.io/bootstrap/ui-bootstrap-tpls-0.12.0.js"></script>
		
		<script>
			var app = angular.module('electronic-door', ['ui.bootstrap']);
			angular.module('electronic-door').controller('controller', function($scope, $http){
				$scope.locals = {
					'authenticated': true,
				};
				$scope.search = {
					'admin': false,
					'active': true,
					'keyed': false,
					'thirtyDays': false,
				};

				$scope.searchForUser = function(){
					// @TODO: encode search string
					var params = {}
					if($scope.search.query && $scope.search.query != '') params['q'] = $scope.search.query;
					if($scope.search.admin) params['isAdmin'] = 1;
					if($scope.search.active) params['status'] = 'active';
					if($scope.search.keyed) params['keyActive'] = 1;
					if($scope.search.thirtyDays){
						var today = new Date();
						var thirtyDaysAgo = (new Date()).setDate(today.getDate()-30);
						params['memberSince'] = Math.floor(thirtyDaysAgo / 1000);
					}
					
					var url = '/users?';
					for(var p in params){
						url += p + '=' + params[p] + '&';
					}
					$http.get(url).success(function(users){
						$scope.userSearchResults = users;
					});
				};
				$scope.userSearchResults = [];
				
				$scope.setCurrentUser = function(user){
					$scope.currentUser = user;
				};				
				$scope.currentUser = null;
			});
			
			app.directive('toggle', function() {
				return {
					require: 'ngModel',
					restrict: 'A',
					scope: { ngModel: '=' },
					link: function postLink(scope, element, attributes) {
						element.bind('click', function(event){
							scope.ngModel = !scope.ngModel;
							if(scope.ngModel){
								element.addClass('active');
							}else{
								element.removeClass('active');
							}
							
							scope.$apply();
						});
					},
				}
			});
		</script>
	</head>
	
	<body>
		<div ng-controller="controller">
			<h1 style="text-align:center"><img src="/images/logo-header.svg" alt="MakeICT" /></h1>
			<div ng-if="!locals.authenticated" class="form">
				<p><em></em>You're in trouble, program. Why don't you make it easy on yourself? Who's your user?</em></p>
				<form class="form" id="login-form">
					<input type="email" class="form-control" placeholder="Email">
					<input type="password" class="form-control" placeholder="Password">
					<button type="submit" class="btn btn-default">Sign in</button>
				</form>
			</div>
			
			<div ng-if="locals.authenticated">
				<div id="status-header">
					Alarm status: <span>Lorem Ipsum</span>
				</div>

				<tabset>
					<tab heading="Status" id="status-tab">
						<h2>Status</h2>
						<p>System status, alarm controls</p>
					</tab>
					<tab heading="Users" id="users-tab">
						<div ng-if="currentUser == null">
							<h2>Users</h2>
							Search users: <input type="text" ng-model="search.query" ng-change="searchForUser()"/>
							<div style="margin-top: 0.5em;">
								<span class="btn-group">
									<span toggle class="btn btn-default btn-sm" ng-click="searchForUser()" ng-model="search.admin">Admin</span>
									<span toggle class="btn btn-default btn-sm" ng-click="searchForUser()" ng-model="search.active">Active</span>
									<span toggle class="btn btn-default btn-sm" ng-click="searchForUser()" ng-model="search.keyed">Keyed</span>
									<span toggle class="btn btn-default btn-sm" ng-click="searchForUser()" ng-model="search.thirtyDays">30+ days</span>
								</span>
							</div>
							<hr/>
							<h3 ng-if="userSearchResults.length == 0">No search results</h3>
							<div ng-if="userSearchResults.length > 0">
								<h3>Search results</h3>
								
								<accordion close-others="true">
									<accordion-group ng-repeat="user in userSearchResults">
										<accordion-heading>
											<h4 onclick="$('html, body').animate({ scrollTop: $(this).offset().top }, 1000);">{{user.firstName}} {{user.lastName}}</h4>
										</accordion-heading>
										<h4><a href="mailto:{{user.email}}">{{user.email}}</a></h4>
										<table class="table table-striped user-details">
											<tr>
												<th>Account type</th>
												<td>
													<form class="form-inline">
														<div class="btn-group">
															<label class="btn btn-sm btn-default" ng-model="user.isAdmin" btn-radio="false">User</label>
															<label class="btn btn-sm btn-default" ng-model="user.isAdmin" btn-radio="true">Admin</label>
														</div>
															
														<span ng-if="user.isAdmin" class="btn-group">
															&nbsp;
															<input type="password" placeholder="New password" class="form-control input-sm btn"/>
															<span ng-if="user.passwordSaved" class="glyphicon glyphicon-glyphicon glyphicon-ok" aria-hidden="true"></span>
														</span>
													</form>
												</td>
											<tr>
												<th>Member status</th>
												<td>{{user.status}}</td>
											</tr><tr>
												<th>Member since</th>
												<td>{{user.memberSince}}</td>
											</tr><tr>
												<th>Member for</th>
												<td>000 days</td>
											</tr><tr>
												<th>Key status</th>
												<td>
													<div class="btn-group">
														<label class="btn btn-sm btn-default" ng-model="user.keyActive" btn-radio="false">No key</label>
														<label class="btn btn-sm btn-default" ng-model="user.keyActive" btn-radio="true">{{user.keyActive?"Enrolled":"Enroll now"}}</label>
													</div>
												</td>
											</tr>
										</table>
									</accordion-group>
							</div>
						</div>
					</tab>
					<tab heading="Clients" id="clients-tab">
						<h2>Clients</h2>
						<p>Options and commands for connected readers, door controls, buzzers, relays, etc</p>
					</tab>
					<tab heading="Activity Log" id="log-tab">
						<h2>Activity Log</h2>
						<p>Big fat table</p>
					</tab>
					<tab heading="Options" id="options-tab">
						<h2>System Options</h2>
						<p>Yo</p>
						<h2>Personal Options</h2>
						<p>Yo</p>
					</tab>
				</tabset>
			</div>
		</div>
	</body>
</html>
