<!DOCTYPE html>

<html ng-app="electronic-door">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>

		<title>MakeICT Master Control Program</title>

		<link rel="icon" href="" />
		<link rel="stylesheet" href="/css/bootstrap/bootstrap.min.css" />
		<link rel="stylesheet" href="/css/bootstrap-slate.min.css" />
		<link rel="stylesheet" href="/css/mcp.css" />

		<script src="/js/jquery.min.js"></script>
		<script src="/js/socket.io.js"></script>
		<script src="/js/angular/angular.js"></script>
		<script src="/js/bootstrap/bootstrap.min.js"></script>
		<script src="/js/ui-bootstrap-tpls.js"></script>

		<script src="/js/MainController.js"></script>
	</head>

	<body>
		<div ng-controller="controller">
			<h1 style="text-align:center"><img src="/images/logo-header.svg" alt="MakeICT" /></h1>
			<div ng-if="!locals.authenticated" class="form">
				<p><em></em>You're in trouble, program. Why don't you make it easy on yourself? Who's your user?</em></p>
				<form class="form" id="login-form">
					<input type="email" class="form-control" placeholder="Email">
					<input type="password" class="form-control" placeholder="Password">
					<button type="submit" class="btn btn-default">Sign in</button>
				</form>
			</div>

			<div ng-if="locals.authenticated">
				<div id="status-header">
					Alarm status: <span>Lorem Ipsum</span>
				</div>

				<uib-tabset>
					<uib-tab heading="Status">
						<h2>Status</h2>
						<p>System status, alarm controls</p>
					</uib-tab>
					<uib-tab heading="Users">
						<h2>Users</h2>
						Search users: <input type="text" ng-model="search.query" ng-change="searchForUser()"/>
						<div style="margin-top: 0.5em;">
							<span class="btn-group">
								<span toggle class="btn btn-default btn-sm" ng-click="searchForUser()" ng-model="search.admin">Admin</span>
								<span toggle class="btn btn-default btn-sm" ng-click="searchForUser()" ng-model="search.active">Active</span>
								<span toggle class="btn btn-default btn-sm" ng-click="searchForUser()" ng-model="search.keyed">Keyed</span>
								<span toggle class="btn btn-default btn-sm" ng-click="searchForUser()" ng-model="search.thirtyDays">30+ days</span>
							</span>
						</div>
						<hr/>
						<uib-accordion close-others="true">
							<uib-accordion-group>
								<uib-accordion-heading>
									<h4 onclick="$('html, body').animate({ scrollTop: $(this).offset().top }, 1000);">Add new</h4>
								</uib-accordion-heading>
								<h4><a href="mailto:{{user.email}}">{{user.email}}</a></h4>
								<form>
									<table class="table table-striped user-details">
										<tr>
											<th>Email</th>
											<td><input type="email" ng-model="newUser.email"></td>
										</tr><tr>
											<th>First Name</th>
											<td><input type="text" ng-model="newUser.firstName"></td>
										</tr><tr>
											<th>Last Name</th>
											<td><input type="text" ng-model="newUser.lastName"></td>
										</tr><tr>
											<th>Join Date</th>
											<td><input type="date" ng-model="newUser.joinDate"></td>
										</tr>
									</table>
									<button class="btn btn-link btn-sm" ng-click="resetNewUser()">Reset</button>
									<button class="btn btn-primary btn-sm" ng-click="saveNewUser()">Save</button>
								</form>
							</uib-accordion-group>
						</uib-accordian>
						<hr/>
						<h3 ng-if="userSearchResults.length == 0">No search results</h3>
						<div ng-if="userSearchResults.length > 0">
							<h3>Search results</h3>

							<uib-accordion close-others="true">
								<uib-accordion-group ng-repeat="user in userSearchResults">
									<uib-accordion-heading>
										<h4 onclick="$('html, body').animate({ scrollTop: $(this).offset().top }, 1000);">{{user.firstName}} {{user.lastName}}</h4>
									</uib-accordion-heading>
									<h4><a href="mailto:{{user.email}}">{{user.email}}</a></h4>
									<table class="table table-striped user-details">
										<tr>
											<th>Account type</th>
											<td>
												<form class="form-inline">
													<div class="btn-group">
														<label class="btn btn-sm btn-default" ng-model="user.isAdmin" btn-radio="false">User</label>
														<label class="btn btn-sm btn-default" ng-model="user.isAdmin" btn-radio="true">Admin</label>
													</div>

													<span ng-if="user.isAdmin" class="btn-group">
														&nbsp;
														<input type="password" placeholder="New password" class="form-control input-sm btn"/>
														<span ng-if="user.passwordSaved" class="glyphicon glyphicon-glyphicon glyphicon-ok" aria-hidden="true"></span>
													</span>
												</form>
											</td>
										</tr><tr>
											<th>Member status</th>
											<td>{{user.status}}</td>
										</tr><tr>
											<th>Member since</th>
											<td>{{user.joinDate|timestampToHumanReadableDate}}</td>
										</tr><tr>
											<th>Member for</th>
											<td>{{user.joinDate|timestampToHumanReadableDuration}} days</td>
										</tr><tr>
											<th>Key status</th>
											<td>
												{{user.keyActive?"Enrolled":"NOT Enrolled"}}
												<button class="btn btn-sm btn-default" ng-click="toggleKeyEnrollment(user)">{{user.keyActive?"Unenroll":"Enroll now"}}</button>
												<table ng-if="nfcLog && nfcLog.length > 0">
													<tr ng-repeat="log in nfcLog">
														<td>{{log.timestamp|timestampToHumanReadableDate:true}}</td>
														<td><button class="btn btn-sm btn-default" ng-click="enrollUser(user, log.code)">{{log.code}}</button></td>
													</tr>
												</table>
												<div ng-if="nfcLog && nfcLog.length == 0">
													Please scan an NFC card and try again.
												</div>
											</td>
										</tr><tr>
											<th>Authorizations</th>
											<td>
												<button ng-if="!user.authorizations" ng-click="getUserAuthorizations(user);">Load authorizations</button>
												<button
													ng-repeat="auth in user.authorizations"
													uib-btn-checkbox
													ng-model="auth.authorized"
													ng-click="setUserAuthorization(user, auth.name, auth.authorized)"
													type="button"
													class="btn btn-default btn-sm"
												>
													{{auth.name}}
												</button>
											</td>
										</tr>
									</table>
								</uib-accordion-group>
							</accordion>
						</div>
					</uib-tab>
					<uib-tab heading="Clients">
						<h2>Clients</h2>
						<div ng-repeat="client in clients" class="well pull-left client-container">
							<h3>{{client.name}}</h3>
							<table>
								<tbody>
									<tr>
										<td>ID:</td>
										<td><input type="text" ng-model="client.clientID" /></td>
									</tr>
									<tr>
										<td>Name:</td>
										<td><input type="text" ng-model="client.name" /></td>
									</tr>
								</tbody>
								<tbody>
									<tr>
										<td>Plugins:</td>
										<td>
											<select ng-change="createClientPluginAssociation(client, client.newPlugin)" ng-model="client.newPlugin">
												<option disabled selected hidden value=""> - Bind new plugin - </option>
												<option ng-repeat="plugin in clientPlugins" value="{{plugin.name}}">{{plugin.name}}</option>
											</select>
										</td>
									</tr>
								</tbody>
								<tbody ng-repeat="plugin in client.plugins">
									<tr>
										<th colspan="2" class="plugin-name">{{plugin.name}}</th>
									</tr>
									<tr ng-repeat="option in plugin.options">
										<td>{{option.name}}</td>
										<td><input type="text" ng-model="option.value" ng-change="saveClientPluginOption(client, plugin, option)"/></td>
									</tr>
									<tr>
										<td colspan="2" class="client-plugin-actions">
											<button class="btn btn-default btn-sm" ng-repeat="action in plugin.actions" ng-click="doClientPluginAction(client, plugin, action)">{{action}}</button>
										</td>
								</tbody>
							</table>
							<br/>
						</div>
					</uib-tab>
					<uib-tab heading="Activity Log">
						<h2>Activity Log</h2>
						<button ng-click="loadLog()">Load</button>
						<table>
							<thead>
								<tr>
									<th>Timestamp</th>
									<th>Log Type</th>
									<th>Message</th>
									<th>User</th>
									<th>NFC</th>
								</tr>
							</thead>
							<tbody>
								<tr ng-repeat="row in log">
									<td>{{row.timestamp|timestampToHumanReadableDate:true}}</td>
									<td>{{row.logType}}</td>
									<td>{{row.message}}</td>
									<td>{{row.user}}</td>
									<td>{{row.code}}</td>
								</tr>
							</tbody>
						</table>
					</uib-tab>
					<uib-tab heading="Options">
						<h2>System Options</h2>
						<p>Yo</p>
						<h2>Personal Options</h2>
						<p>Yo</p>
					</uib-tab>
					<uib-tab heading="Plugins">
						<h2>Plugins</h2>
						<div ng-repeat="plugin in plugins" class="well pull-left plugin-container">
							<h3>{{plugin.name}}</h3>
							<div class="btn-group">
								<label class="btn btn-sm btn-default" ng-model="plugin.enabled" btn-radio="false" ng-click="togglePlugin(plugin, false)">Off</label>
								<label class="btn btn-sm btn-default" ng-model="plugin.enabled" btn-radio="true" ng-click="togglePlugin(plugin, true)">On</label>
							</div>
							<br/><br/>
							<table>
								<tr ng-repeat="option in plugin.options">
									<td>{{option.name}}</td>
									<td><input ng-model="option.value" ng-change="savePluginOption(plugin, option)" type="{{option.type == 'password' ? 'password' : 'text'}}"></td>
								</tr>
							</table><br/>
							<button class="btn btn-default btn-sm" ng-repeat="action in plugin.actionNames" ng-click="doPluginAction(plugin, action)">{{action}}</button>
						</div>
					</uib-tab>
				</tabset>
			</div>
		</div>
	</body>
</html>
